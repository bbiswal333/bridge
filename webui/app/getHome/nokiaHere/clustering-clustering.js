(function(){ovi.provide("nokia.maps.clustering.ColorizerTheme");
(function(e){var l=e.util.d;e.clustering.ColorizerTheme=new ovi.Class({initialize:function(){},getClusterPresentation:function(h){var h=h.getPoints?h.Nb:h,d=h.length,c,g;c=(16777216*Math.random()|0).toString(16);g="#"+c+(c.length==5?"f":"");var b=new e.map.Container;for((!h||d==0)&&l("Please provide at least one data point");c=h[--d];)b.objects.add(new e.map.StandardMarker(c,{brush:{color:g}}));return b},getNoisePresentation:function(h){return new e.map.StandardMarker(h,{brush:{color:"#CCCCCC"}})}})})(nokia.maps);
ovi.provide("nokia.maps.clustering.Noise");
(function(e){e.clustering.Noise=new ovi.Class({initialize:function(e){this.Xd=e},isAdded:!1,Xd:null,wf:null,Hc:null,getCoordinate:function(){if(!this.Ep)this.Ep=this.Xd.$geo||new e.geo.Coordinate(this.Xd.latitude,this.Xd.longitude);return this.Ep},getIcon:function(e,h){if(!this.Hc||h)this.Hc=e.getNoisePresentation(this.Xd);return this.Hc},getPoint:function(){return this.Xd},render:function(e,h,d){h=this.getIcon(h,d);this.isAdded&&e.remove(h);if((!this.isAdded||d)&&h)e.add(h),this.isAdded=!0},destroy:function(){this.isAdded=
!1;this.Hc=this.wf=this.Xd=null}})})(nokia.maps);ovi.provide("nokia.maps.clustering.Cluster");
(function(e){var l=ovi.Array.indexOf,h=e.geo.BoundingBox;e.clustering.Cluster=new ovi.Class({initialize:function(d,c){var e=parseInt(c&&c.gridCellSize);this.Nb=d?[d]:[];if(c)this.ha=c.display;if(e&&e>0)this.Em=e},isAdded:!1,getBounds:function(){if(this.Nb&&this.Nb.length!==0){if(!this.fk)this.fk=h.coverAll(this.Nb);return this.fk}},getClusterBounds:function(){return this.vp||this.getBounds()},getPoints:function(){return this.Nb},getSize:function(){return this.Nb.length},push:function(d){if(this.Fu(d))return!1;
if(this.ha&&this.Em){if(!this.Rc)this.Rc=d.$geo,this.jt();d.$ia=!0}else this.fk=null;this.Nb.push(d)},Fu:function(d){return l(this.Nb,d)>=0},jt:function(){var d=this.Em,c=this.ha,e=c.geoToPixel(this.Rc);this.vp=h.coverAll([this.Rc,c.pixelToGeo(e.x-d,e.y-d),c.pixelToGeo(e.x+d,e.y+d)])},getCenter:function(){return this.Rc},destroy:function(){this.isAdded=!1;this.Nb=this.vp=this.fk=this.Rc=this.Hc=this.ha=this.Em=null},getIcon:function(d,c){if(!this.Hc||c)this.Hc=d.getClusterPresentation(this);return this.Hc},
render:function(d,c,e){c=this.getIcon(c,e);this.isAdded&&d.remove(c);if((!this.isAdded||e)&&c)d.add(c),this.isAdded=!0}})})(nokia.maps);ovi.provide("nokia.maps.clustering.ITheme");ovi.provide("nokia.maps.clustering.IClusterPoint");ovi.provide("nokia.maps.clustering.Index");
(function(e){function l(b,a){for(var c=a.length,d,b=new ovi.Array(b);d=a[--c];)g(b,d)==-1&&b.push(d);return b}var h=e.util,d=h.RTree,c=h.RTreeRecord,g=ovi.Array.indexOf,b=h.d,f={algorithm:d.QUADRATIC_PARTITIONING,min:12,max:32};e.clustering.Index=new ovi.Class({initialize:function(c){var a,e,c=c||{};a=c.max||f.max;e=c.min||f.min;c=c.algorithm||f.algorithm;(typeof a!="number"||a<2)&&b("The given parameter 'max' is not a number, or less than 2! max is "+a);(typeof e!="number"||e>a/2||e<1)&&b("The given parameter 'min' is not a number, or is not at least 2 times smaller than max! min is"+
e);(typeof c!="number"||c>3||c<0)&&b("The given algorithm "+c+" is not supported. Please specify value from 0 to 3.");this.xa={max:a,min:e,algorithm:c};this.K=new d(this.xa.algorithm,this.xa.max,this.xa.min);this.Ya={}},add:function(b){var a;a=b.x;var d=b.y;a=new c(a-0.5,d-0.5,a+0.5,d+0.5);this.K.add(a);a.$coordinate=b;this.Ya[b]=a},remove:function(c){(!c||c.x==void 0||c.y==void 0)&&b("Invalid coordinate");this.Ya[c]!=void 0&&(this.K.remove(this.Ya[c]),delete this.Ya[c])},clean:function(){this.K.removeAll()},
destroy:function(){this.clean();this.K=null},getNeighborhood:function(b,a,c){var d=b.x,f=b.y,b=d+a;d-=a;var e=f-a,a=f+a;if(b>c)return l(this.K.search(d,c,e,a),this.K.search(0,b-c,e,a));else if(d<0)return l(this.K.search(0,b,e,a),this.K.search(c+d,c,e,a));return this.K.search(d,b,e,a)}})})(nokia.maps);ovi.provide("nokia.maps.clustering.RectangleTheme");
(function(e){var l=e.util.d,h=e.gfx.GraphicsImage,d=e.map.Rectangle;e.clustering.RectangleTheme=new ovi.Class({initialize:function(){this.dn=new h(function(c){c.beginImage(22,22,"ClusteringNoisePoint");c.set("lineWidth",2);c.set("strokeColor","#ffffff");c.set("fillColor","#1080DD");c.drawEllipse(10,10,10,10);c.stroke();c.fill()})},getClusterPresentation:function(c){var g=c.getSize?c.getSize():c.length;(!c||g==0)&&l("Please provide at least one data point");return new d(c.getBounds?c.getBounds():e.geo.BoundingBox.coverAll(c),
{pen:{strokeColor:"#000",lineWidth:1},brush:{color:"#CC2A"}})},getNoisePresentation:function(c){return new e.map.Marker(c,{icon:this.dn})}})})(nokia.maps);ovi.provide("nokia.maps.clustering.MarkerTheme");
(function(e){var l=e.util.d,h=e.gfx.GraphicsImage,d=e.geo.BoundingBox.Ic,c=e.clustering.MarkerTheme=new ovi.Class({initialize:function(d){this.Ye=d==c.POSITION_CENTER||d==c.POSITION_FIRST||d==c.POSITION_WEIGHT_CENTER?d:"weight";this.dn=new h(function(b){b.beginImage(14,14,"ClusteringNoisePoint");b.set("lineWidth",2);b.set("strokeColor","#FFFFFF");b.set("fillColor","#1080DD");b.drawEllipse(2,2,10,10);b.stroke();b.fill()})},Statics:{POSITION_CENTER:"center",POSITION_FIRST:"first",POSITION_WEIGHT_CENTER:"weight",
getColor:function(c){return c<10?"#76D100":c<25?"#FF6900":c<50?"#F03C00":"#B50015"}},cu:function(c){var b=c.length,f=0,e=0,a=0,h=0,k,m;m=!1;for(var p,l;k=c[--b];){p=parseFloat(k.value);if(isNaN(p)||p<0)p=1;m=k.latitude;k=k.longitude;f+=m*p;e+=(k<0?k+360:k)*p;a+=k*p;h+=p;l=!l?[m,k,m,k]:d(l,[m,k,m,k])}m=l[1]>l[3];k=(m?e:a)/h;return{latitude:f/h,longitude:m&&k>180?k-360:k}},bu:function(c){return e.geo.BoundingBox.coverAll(c).getCenter()},getClusterCoordinate:function(d){d=d.getSize!=null?d.Nb:d;return this.Ye==
c.POSITION_WEIGHT_CENTER?this.cu(d):this.Ye==c.POSITION_CENTER?this.bu(d):d[0]},getClusterPresentation:function(d){var b,f,r=d.getSize!=null,a=r?d.getSize():d.length,r=this.getClusterCoordinate(r?d.Nb:d),q=c.getColor(a);(!d||a==0)&&l("Please provide at least one data point");d=(a+"").length;b=d*2+4;f=(d==1?8:d*3+5)*2+b*2;return new e.map.Marker(r,{icon:new h(function(c){c.beginImage(f,f,"Cluster");c.set("fillColor",q+"30");c.drawEllipse(0,0,f,f);c.fill();c.set("fillColor",q);c.drawEllipse(b,b,f-b*
2,f-b*2);c.fill();c.set("font","12px tahoma");c.set("fillColor","#ffffff");c.set("textAlign","center");c.fillText(a,f/2,f/2+4.5)}),anchor:{x:f/2,y:f/2}})},getNoisePresentation:function(c){return new e.map.Marker(c,{icon:this.dn,anchor:{x:7,y:7}})}})})(nokia.maps);ovi.provide("nokia.maps.clustering.ClusterProvider");
(function(e){function l(a,b){typeof a!="number"&&(a=parseInt(a,10));return isNaN(a)||a<b?b:a}var h=e.util,d=Math.max,c=Math.min,g=h.Coroutine,b=e.clustering,f=ovi.Array.indexOf,r={eps:50,min:0,max:20,minPts:1,strategy:0,index:null,theme:new b.MarkerTheme},a=b.Index,q=h.d,k=b.ClusterProvider=new ovi.Class({Extends:e.map.provider.Provider,Mixins:[h.OObject],initialize:function(b,f){var g,h=ovi.extend({},r,f||{}),u=h.index,w=h.strategy;this.isValidDisplay(b)||q("Display is not provided.");this.Cf=l(h.eps,
10);this.Lh=l(h.minPts,1);this.setTheme(h.theme);this.min=d(l(0,h.min),r.min);this.max=c(l(0,h.max),r.max);this.label="Clustering";this.description="Manages markers and spatial objects and creates clusters out of them.";this.Ya=[];this.Sc=[];this.rd=[];this.ha=b;this.Sg=new e.map.Container;this.Kd=new e.map.Container;this.Ve=new e.map.Container;b.objects.add(this.Sg);this.Sg.objects.add(this.Kd);this.Sg.objects.add(this.Ve);g=this.ha.baseMapType.width;this.Qu=this.ha.baseMapType.projection.latLngToMapPoint;
this.Bs=30-Math.log(g)/Math.log(2);this.Js=g*(1<<this.Bs);w===0||w===1?this.Li=w:q("Invalid clustering strategy. Possible values are 0 and 1");u&&!(u instanceof a)&&q("Provided index data structure is invalid.");if(this.Li==k.STRATEGY_DENSITY_BASED)this.index=u||new a;this.addAll(h.dataPoints||[]);this.$s();this.set("state",k.STATE_INITIAL)},Statics:{STATE_INITIAL:"initial",STATE_STARTED:"started",STATE_CLUSTERED:"clustered",STATE_READY:"ready",STRATEGY_DENSITY_BASED:0,STRATEGY_GRID_BASED:1},ha:null,
lx:null,Ae:!1,cluster:function(){var a=this.ha.zoomLevel,b;this.state==k.STATE_STARTED&&this.invalidate();this.Ae=!0;if(this.zp())this.set("state",k.STATE_STARTED),this.Li==k.STRATEGY_GRID_BASED?b=this.hq(this.Ya,this.Cf,this.Lh):(b=this.index?this.Cf*(1<<this.Bs-a):this.Cf,b=this.Nt(this.Ya,b,this.Lh)),this.Sc=b.clusters,this.rd=b.noise,this.set("state",k.STATE_CLUSTERED),this.wg=a,this.Nk(!0)},isValidDisplay:function(a){return a&&a instanceof e.map.Display},Nk:function(a){this.ng=this.ha.getViewBounds();
this.speed.visuals=(new Date).getTime();this.Jr=this.Rv(this,a)},Rv:g.create("nokia.maps.clustering.ClusterProvider#_renderingCo",function(a){var b=a.that,c,d=b.theme,f=a.arguments[1],e=(f?b.Ve:b.Kd).objects,h=a.i;if(!a.isNoiseRendered){for(h=h==void 0?b.rd.length:h;c=b.rd[--h];)if((!c.isAdded||f)&&b.ng.contains(c.getCoordinate())&&c.render(e,d,f),a.i=h,g.shallYield())return g.yield();else if(h%30===0)return g.sleep(10);a.isNoiseRendered=!0}if(h<0||h==void 0)h=b.Sc.length;for(;c=b.Sc[--h];)if((!c.isAdded||
f)&&b.ng.intersects(c.getClusterBounds())&&c.render(e,d,f),a.i=h,g.shallYield())return g.yield();else if(h%10===0)return g.sleep(10);if(f)b.Kd.objects.clear(),a=b.Ve,b.Ve=b.Kd,b.Kd=a;b.speed.visuals=(new Date).getTime()-b.speed.visuals;b.set("state",k.STATE_READY)},{useAnimationFrame:!0},"that","forceCreateIcons"),St:function(a,b){for(var c=b.length;n=b[--c];)if(a==n.Xd)return!0;return!1},hq:function(a,c,d,f,g){function k(a){for(var d=h.Js,e=f.length,g,m,q;e--;)if(m=f[e],g=m.getCenter())g=g.distance(a.$geo),
g<d&&(d=g,q=m);if(!q||!q.getClusterBounds().contains(a.$geo))q=new b.Cluster(null,{gridCellSize:c,display:h.ha}),f.push(q);else if(A&&!a.$ia)q.isAdded=!1;q.push(a)}var h=this,q=h.ha.getViewBounds(),l,r=a.length,C=[],A=!!f,g=g||[],f=f||[];for(h.speed.clustering=(new Date).getTime();l=a[--r];){if(!l.$geo)l.$geo=new e.geo.Coordinate(l.latitude,l.longitude);q.contains(l.$geo)&&k(l)}for(r=f.length;r--;)if(l=f[r],a=l.Nb,a.length<=d)for(j=a.length;l=a[--j];)h.St(a[j],g)||g.push(new b.Noise(a[j]));else C.push(l);
h.speed.clustering=(new Date).getTime()-h.speed.clustering;return{clusters:C,noise:g}},Nt:function(a,c,d){var f,e=a.length,g,k=[],h=[],q;this.speed.clustering=(new Date).getTime();for(f=0;f<e;f++)if(q=a[f],!q.visited)q.visited=!0,g=this.Br(q,c,a),g.length<=d?q.noise=!0:k.push(this.Vt(q,g,c,d,a));for(f=0;f<e;f++)q=a[f],q.noise&&h.push(new b.Noise(q)),delete q.cluster,delete q.visited,delete q.noise;this.speed.clustering=(new Date).getTime()-this.speed.clustering;return{clusters:k,noise:h}},Vt:function(a,
c,d,f,e){var f=0,g,k=[],c=[c],h;a.cluster=!0;for(k=new b.Cluster(a);f<c.length;){h=c[f];for(a=h.length;h[--a];){g=h[a];if(g.$coordinate)g=g.$coordinate;if(!g.visited)g.visited=!0,c.push(this.Br(g,d,e));if(g.noise||!g.cluster)g.cluster=!0,k.push(g)}f++}return k},Br:function(a,b,c){var d=c.length,f=[],e;if(this.index)return this.index.getNeighborhood(a,b,this.Js);else for(b=Math.pow(b,2);e=c[--d];)Math.pow(a.x-e.x,2)+Math.pow(a.y-e.y,2)<=b&&f.push(e);return f},alterIndexRebuild:function(a){var b=this.Ya.length;
this.Li==k.STRATEGY_GRID_BASED&&q("Can not alter index while using grid based clustering.");if(a)this.index=a;for(this.index.clean();b--;)this.index.add(this.Ya[b])},invalidate:function(){if(this.Ae)this.set("state",k.STATE_INITIAL),this.Sc=[],this.rd=[];this.Jr&&g.kill(this.Jr)},speed:{clustering:0,visuals:0},zp:function(){var a=this.ha.zoomLevel;if(a<this.min||a>this.max)return this.invalidate(),this.Kd.objects.clear(),this.Ve.objects.clear(),this.wg=a,this.Sc=[],this.rd=[],this.set("state",k.STATE_CLUSTERED),
!1;return!0},$s:function(){var a=this,b,c=!1;a.ha.addListener("mapviewchangeend",function(){if(a.Ae&&(b=a.ha.getViewBounds(),!a.ng||c||!b.topLeft.equals(a.ng.topLeft)||!b.bottomRight.equals(a.ng.bottomRight))){a.ng=b;if(a.wg!=a.ha.zoomLevel||c)a.invalidate(),a.cluster();else if(a.Li==k.STRATEGY_GRID_BASED&&a.wg==a.ha.zoomLevel){var d;if(a.zp())a.set("state",k.STATE_STARTED),d=a.hq(a.Ya,a.Cf,a.Lh,a.Sc,a.rd),a.Sc=d.clusters,a.rd=d.noise,a.set("state",k.STATE_CLUSTERED),a.Nk()}else a.Li==k.STRATEGY_DENSITY_BASED&&
a.Nk();c=!1}});a.addObserver("theme",function(){a.Ae&&a.Nk(!0)})},add:function(a){var b;this.invalidate();this.Ya.push(a);if(this.index)b=this.Qu(a.latitude,a.longitude),a.x=b.x,a.y=b.y,this.index.add(a)},addAll:function(a,b){var c=a.length;for(this.invalidate();c--;)this.add(a[c]);b&&b()},remove:function(a){var b=a?f(this.Ya,a):-1;b>=0&&(this.invalidate(),this.Ya.splice(b,1));this.index&&this.index.remove(a)},clean:function(){this.invalidate();this.Kd.objects.clear();this.Ve.objects.clear();this.index&&
this.index.clean();this.Ya=[];this.Sc=[];this.rd=[];this.Ae=!1;this.set("state",k.STATE_INITIAL)},destroy:function(){this.clean();this.index&&this.index.destroy();this.index=this.Sg=this.Kd=this.Ve=this.ha=null},ux:function(a,b){var c;if(a){this.invalidate();for(c=a.length;c--;)this.remove(a[c])}else this.clean();b&&b()},getContainer:function(){return this.Sg},getDataLength:function(){return this.Ya.length},numberOfClusters:function(){this.Ae||q("Clusters are not available yet. Did you forgot to call cluster method before?");
return this.Sc.length},numberOfNoisePoints:function(){this.Ae||q("Clusters are not available yet. Did you forgot to call cluster method before?");return this.rd.length},setEps:function(a){this.Cf=l(a,10);this.invalidate()},getEps:function(){return this.Cf},setMinPts:function(a){this.Lh=l(a,1);this.invalidate()},getMinPts:function(){return this.Lh},setTheme:function(a){(!a||!a.getClusterPresentation||!a.getNoisePresentation)&&q("Provided theme does not conform to the ITheme interface.");this.set("theme",
a)}})})(nokia.maps);ovi.provide("nokia.maps.clustering._packaging.package-clustering");})();
